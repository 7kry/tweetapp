<!DOCTYPE html>
<html lang='ja'>
  <head>
    <meta charset='utf-8' />
    <title>tweetapp</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel='stylesheet' href='https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css' />
    <script src='https://code.jquery.com/jquery-3.1.1.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.min.js'></script>
    <script src='https://cdn.rawgit.com/twitter/twitter-text/master/js/twitter-text.js'></script>
    <style>
#res > div:hover {
  background-color: #fd4;
}
    </style>
  </head>
  <body>
    <form id='twtform' enctype='multipart/form-data' action='/tweet' method='post' acceptcharset="utf-8">
      <textarea name='text' id='twtbox'></textarea>
      <input type='submit' value='0' id='twtbtn' />
      <input type='file' name='media[]' multiple accept="image/*" />
    </form>
    <hr />
    <div id='res'></div>
    <script>
var reflesh_count = function(){
  $('#twtbtn').val(twttr.txt.getTweetLength($('#twtbox').val()));
};
$('#twtbox').addClass('ui-widget ui-corner-all').css({'width': '100%'}).attr('rows', '7')
  .change(reflesh_count).keypress(reflesh_count).keyup(reflesh_count).mousedown(reflesh_count).mouseup(reflesh_count).mouseover(reflesh_count);
$('#twtbtn').button();
var format_tweet = function(tweet, header){
  if('retweeted_status' in tweet){
    return format_tweet(tweet['retweeted_status'], twttr.txt.autoLink(tweet['text'], {urlEntities: tweet['entities']['urls']}).replace(/: .+/, ': '));
  }else{
    var text = $('<div>').html((header === undefined ? '' : header) + twttr.txt.autoLink(tweet['text'], {urlEntities: tweet['entities']['urls']}));
    text.find('a').attr('target', '_blank');
    var res = $('<div>')
      .attr('data-json', JSON.stringify(tweet))
      .css({
        'clear': 'both'
      })
      .attr('data-tweet-id', tweet['id_str'])
      .append($('<input type="button">').button().val('削除').css('float', 'right').click(function(){
        $.get('/destroy', {id: $(this).parent('div').attr('data-tweet-id')}, function(result){
          $('#res > div[data-tweet-id="' + result['id_str'] + '"]').remove();
        });
      }))
      .append(text);
    if('media' in tweet['entities']){
      var cont = $('<div>').css('clear', 'both').appendTo(res);
      ('extended_entities' in tweet ? tweet['extended_entities'] : tweet['entities'])['media'].forEach(function(elem){
        $('<a>').css('clear', 'both').attr('href', elem['media_url_https'] + ':large').attr('target', '_blank').append(
            $('<img>').attr('src', elem['media_url_https']).css({height: 'auto', width: '25%'}))
          .appendTo(cont);
      });
    }
    return res;
  }
};
$('#twtform').on('submit', function(event) {
  event.preventDefault();
  $.ajax(
    $(this).attr('action'),
    {
    type: $(this).attr('method'),
    dataType : "json",
    data: new FormData($('#twtform').get(0)),
    processData: false,
    contentType: false,
    beforeSend: function(xhr, settings) {
      $('#twtbtn').attr('disabled', true);
    },
    complete: function(xhr, textStatus) {
      $('#twtbtn').attr('disabled', false);
    },
    success: function(result, textStatus, xhr) {
      if(xhr.status === 200){
        format_tweet(result).prependTo('#res');
        $('#twtbox').val('');
        reflesh_count();
        $('#twtbox').focus();
      }else{
        alert('送信失敗');
      }
    },
    error: function(xhr, textStatus, error) {
      alert('送信失敗');
    }
  });
});
$.get('/latest', function(result){
  result['statuses'].forEach(function(elem){
    format_tweet(elem).appendTo('#res');
  });
});
    </script>
  </body>
</html>
